<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pre-Test Tracker</title>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Lexend:wght@500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --purple-bg-grad-start: #2b2046;
            --purple-bg-grad-end: #171123;
            --purple-card: rgba(35, 25, 50, 0.95);
            --blue-main: #a29bfe;
            --text-light: #F2F4F5;
            --green-success: #2ecc71;
            --red-danger: #e74c3c;
            --radius-xl: 24px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            /* -webkit-tap-highlight-color: transparent; */
        }

        body {
            font-family: "Lexend", sans-serif;
            background: linear-gradient(180deg, var(--purple-bg-grad-start) 0%, var(--purple-bg-grad-end) 100%) fixed;
            color: var(--text-light);
            min-height: 100dvh;
            width: 100%;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .card {
            background: var(--purple-card);
            border-radius: var(--radius-xl);
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.8rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* --- FILTERS GRID --- */
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.9rem;
            color: var(--blue-main);
            font-weight: 600;
        }

        select,
        input {
            padding: 0.8rem 1rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-family: inherit;
            font-size: 1rem;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--blue-main);
            background: rgba(0, 0, 0, 0.5);
        }

        /* --- SEARCHABLE DROPDOWN --- */
        .dropdown-container {
            position: relative;
        }

        .dropdown-list {
            position: absolute;
            top: 105%;
            left: 0;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            background: #231b32;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            z-index: 50;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .dropdown-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: background 0.1s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.95rem;
        }

        .dropdown-item:hover {
            background: rgba(162, 155, 254, 0.2);
        }

        .hidden {
            display: none !important;
        }

        /* --- STATUS RESULT --- */
        .status-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-top: 1rem;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .status-box.done {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid var(--green-success);
        }

        .status-box.not-done {
            background: rgba(231, 76, 60, 0.15);
            border: 1px solid var(--red-danger);
        }

        .status-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .status-desc {
            opacity: 0.8;
        }

        /* --- TABLE --- */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-input {
            width: 100%;
            max-width: 300px;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        th,
        td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 0, 0, 0.4);
            font-weight: 600;
            color: var(--blue-main);
        }

        tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Badge Styles */
        .badge {
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-mode {
            background: rgba(162, 155, 254, 0.2);
            color: #a29bfe;
        }

        .badge-prog {
            background: rgba(255, 255, 255, 0.15);
        }

        .badge-score {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        /* Spinner */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--blue-main);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .btn-reset {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            height: fit-content;
            align-self: flex-end;
        }

        .btn-reset:hover {
            background: rgba(231, 76, 60, 0.4);
            transform: translateY(-2px);
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Fetching Data...</p>
    </div>

    <div class="container">
        <h1>üîç Pre-Test Tracker</h1>

        <!-- CHECKER CARD -->
        <div class="card">
            <h2>Cek Status Siswa</h2>
            <br>
            <div class="filters-grid">

                <!-- 1. Mode -->
                <div class="form-group">
                    <label>Mode</label>
                    <select id="filter-mode" onchange="handleModeChange()">
                        <option value="" selected>Semua Mode</option>
                        <option value="Online">Online</option>
                        <option value="Offline">Offline</option>
                    </select>
                </div>

                <!-- 2. Program -->
                <div class="form-group">
                    <label>Program</label>
                    <select id="filter-program" onchange="handleProgramChange()">
                        <option value="" selected>Semua Program</option>
                        <option value="coding">Coding</option>
                        <option value="math">Math</option>
                        <option value="cloc">Class of Champions</option>
                    </select>
                </div>

                <!-- 3. City (Offline) -->
                <div class="form-group" id="grp-city" style="display:none;">
                    <label>Kota</label>
                    <select id="filter-city" onchange="handleCityChange()">
                        <option value="">Semua Kota</option>
                    </select>
                </div>

                <!-- 4. Branch (Offline) -->
                <div class="form-group" id="grp-branch" style="display:none;">
                    <label>Cabang</label>
                    <select id="filter-branch" onchange="handleBranchChange()">
                        <option value="">Semua Cabang</option>
                    </select>
                </div>

                <!-- RESET BUTTON -->
                <div class="form-group" style="justify-content: flex-end;">
                    <button onclick="resetFilters()" class="btn-reset">
                        üîÑ Reset Filter
                    </button>
                </div>

            </div>

            <!-- NAME SEARCH -->
            <div class="form-group dropdown-container">
                <label>Cari Nama Siswa</label>
                <input type="text" id="search-name" placeholder="Ketik nama siswa..." autocomplete="off"
                    oninput="filterNameDropdown()" onfocus="filterNameDropdown()">
                <div class="dropdown-list" id="name-dropdown"></div>
            </div>

            <!-- RESULT BOX -->
            <div id="status-result" class="status-box hidden">
                <div class="status-title" id="status-title">...</div>
                <div class="status-desc" id="status-desc">...</div>
            </div>
        </div>

        <!-- TABLE CARD -->
        <div class="card">
            <div class="table-controls">
                <h2>üìã Data Pre-Test Masuk</h2>
                <input type="text" id="table-search" class="search-input" placeholder="Cari di tabel..."
                    onkeyup="renderTable()">
            </div>

            <div class="table-responsive">
                <table id="submissions-table">
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Nama</th>
                            <th>Mode</th>
                            <th>Program</th>
                            <th>Cabang/Kota</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL STATE ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyLEBGpAri8cZSDHeOoJRzf7-3c8RKHH1zNP2A4Fkl54NXROhFpegTYM3mEAL02Y_Co/exec";

        let rawData = {};
        let submissions = [];
        let availableStudents = [];

        // --- INIT ---
        window.onload = function () {
            loadAllData();
        };

        function loadAllData() {
            document.getElementById('loading-overlay').classList.remove('hidden');

            // 1. Fetch Metadata (Forms Data)
            const p1 = fetch(GAS_URL)
                .then(res => res.json())
                .catch(err => {
                    console.error("Metadata Fetch Error:", err);
                    return {};
                });

            // 2. Fetch Submissions (Action Param)
            const p2 = fetch(GAS_URL + "?action=get_submissions")
                .then(res => res.json())
                .catch(err => {
                    console.error("Submissions Fetch Error:", err);
                    return [];
                });

            Promise.all([p1, p2])
                .then(([formDropdowns, subs]) => {
                    console.log("Data Loaded:", { metadata: formDropdowns, submissions: subs });

                    // Fallback if fetch fails (empty objects)
                    rawData = formDropdowns || {};
                    // Ensure structure exists
                    if (!rawData.branches) rawData.branches = {};
                    if (!rawData.students) rawData.students = {};
                    if (!rawData.onlineStudents) rawData.onlineStudents = {};

                    submissions = subs || [];

                    initUI();
                    document.getElementById('loading-overlay').classList.add('hidden');
                })
                .catch(err => {
                    alert("Gagal memuat data: " + err);
                    document.getElementById('loading-overlay').classList.add('hidden');
                });
        }

        function initUI() {
            handleModeChange();
            renderTable();
        }

        // --- HANDLERS ---

        function handleModeChange() {
            const mode = document.getElementById('filter-mode').value;
            const grpCity = document.getElementById('grp-city');
            const grpBranch = document.getElementById('grp-branch');

            if (mode === 'Offline') {
                grpCity.style.display = 'flex';
                grpBranch.style.display = 'flex';
                populateCityDropdown();
            } else {
                grpCity.style.display = 'none';
                grpBranch.style.display = 'none';
            }
            // Reset downstream
            document.getElementById('filter-city').value = "";
            document.getElementById('filter-branch').value = "";

            updateStudentList();
            renderTable(); // Update Table
        }

        function handleProgramChange() {
            // Re-populate cities if offline
            if (document.getElementById('filter-mode').value === 'Offline') {
                populateCityDropdown();
            }
            updateStudentList();
            renderTable(); // Update Table
        }

        function handleCityChange() {
            populateBranchDropdown();
            updateStudentList();
            renderTable(); // Update Table
        }

        function handleBranchChange() {
            updateStudentList();
            renderTable(); // Update Table
        }

        function resetFilters() {
            document.getElementById('filter-mode').value = "";
            document.getElementById('filter-program').value = "";
            document.getElementById('filter-city').value = "";
            document.getElementById('filter-branch').value = "";
            document.getElementById('table-search').value = "";

            // Reset UI Visibility
            document.getElementById('grp-city').style.display = 'none';
            document.getElementById('grp-branch').style.display = 'none';

            // Reset Checker Results
            document.getElementById('search-name').value = "";
            document.getElementById('status-result').classList.add('hidden');

            updateStudentList();
            renderTable();
        }

        // --- POPULATORS ---

        function populateCityDropdown() {
            const program = document.getElementById('filter-program').value || 'coding';
            const citySelect = document.getElementById('filter-city');
            const currentCity = citySelect.value;

            citySelect.innerHTML = '<option value="">Semua Kota</option>';

            // Get branches data from rawData
            const branchMap = rawData.branches[program] || {};

            if (Object.keys(branchMap).length === 0) {
                // Try to handle case where data might be missing
                // console.warn("No offline data for program:", program);
            }

            Object.keys(branchMap).sort().forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = city;
                citySelect.appendChild(opt);
            });

            if (currentCity && branchMap[currentCity]) citySelect.value = currentCity;
            else citySelect.value = "";

            populateBranchDropdown(); // Refresh branches
        }

        function populateBranchDropdown() {
            const program = document.getElementById('filter-program').value || 'coding';
            const city = document.getElementById('filter-city').value;
            const branchSelect = document.getElementById('filter-branch');

            branchSelect.innerHTML = '<option value="">Semua Cabang</option>';

            if (!city) return;

            const branchMap = rawData.branches[program] || {};
            const branches = branchMap[city] || [];

            branches.sort().forEach(br => {
                const opt = document.createElement('option');
                opt.value = br;
                opt.textContent = br;
                branchSelect.appendChild(opt);
            });
        }

        function updateStudentList() {
            const mode = document.getElementById('filter-mode').value;
            const program = document.getElementById('filter-program').value;
            const city = document.getElementById('filter-city').value;
            const branch = document.getElementById('filter-branch').value;

            // Clear search
            document.getElementById('search-name').value = '';
            document.getElementById('status-result').classList.add('hidden');

            availableStudents = [];

            // Get all unique programs available in data
            const allProgs = new Set([
                ...Object.keys(rawData.onlineStudents || {}),
                ...Object.keys(rawData.students || {})
            ]);

            // Which programs to look at?
            const targetProgs = program ? [program] : Array.from(allProgs);

            targetProgs.forEach(prog => {
                // 1. Add Online Students (If mode is 'Online' or Not Set)
                if (!mode || mode === 'Online') {
                    const list = rawData.onlineStudents[prog] || [];
                    list.forEach(name => {
                        availableStudents.push({ name, city: 'Online', branch: 'Online', program: prog });
                    });
                }

                // 2. Add Offline Students (If mode is 'Offline' or Not Set)
                if (!mode || mode === 'Offline') {
                    let list = rawData.students[prog] || [];

                    // Apply City/Branch filters if they exist
                    if (city) list = list.filter(s => s.city === city);
                    if (branch) list = list.filter(s => s.branch === branch);

                    list.forEach(s => {
                        // Spread to avoid mutating original rawData if we ever cache it differently
                        availableStudents.push({ ...s, program: prog });
                    });
                }
            });
        }

        function filterNameDropdown() {
            const input = document.getElementById('search-name');
            const dropdown = document.getElementById('name-dropdown');
            const filter = input.value.toLowerCase();

            dropdown.innerHTML = '';

            if (!filter && document.activeElement !== input) {
                dropdown.style.display = 'none';
                return;
            }

            // Sort alphabetical
            const matches = availableStudents
                .filter(s => s.name.toLowerCase().includes(filter))
                .sort((a, b) => a.name.localeCompare(b.name));

            if (matches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.style.display = 'block';

            matches.slice(0, 50).forEach(s => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                const extra = (s.city !== 'Online') ? ` <small style="opacity:0.6">(${s.city})</small>` : '';
                div.innerHTML = s.name + extra;
                div.onclick = () => selectStudent(s);
                dropdown.appendChild(div);
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const container = document.querySelector('.dropdown-container');
            if (!container.contains(e.target)) {
                document.getElementById('name-dropdown').style.display = 'none';
            }
            // Also re-render table if clicking body (optional, but good for blur)
        });

        function selectStudent(studentObj) {
            document.getElementById('search-name').value = studentObj.name;
            document.getElementById('name-dropdown').style.display = 'none';
            checkStatus(studentObj);
        }

        function checkStatus(studentObj) {
            const resultBox = document.getElementById('status-result');
            const title = document.getElementById('status-title');
            const desc = document.getElementById('status-desc');

            resultBox.classList.remove('hidden', 'done', 'not-done');

            // Find specific submission
            // Use filter program OR student object's program (important if search was done without filters)
            const fProg = (document.getElementById('filter-program').value || studentObj.program || "").toLowerCase();

            const match = submissions.find(sub => {
                const subProg = (sub.program || "").toString().toLowerCase().trim();
                const nameMatch = sub.name.toLowerCase().trim() === studentObj.name.toLowerCase().trim();

                if (fProg) return nameMatch && subProg === fProg;
                return nameMatch;
            });

            if (match) {
                resultBox.classList.add('done');
                title.textContent = "‚úÖ SUDAH MENGERJAKAN";
                title.style.color = "#2ecc71";

                let dateStr = "";
                try {
                    dateStr = new Date(match.timestamp).toLocaleString();
                } catch (e) { dateStr = match.timestamp; }

                desc.innerHTML = `Selesai pada: <b>${dateStr}</b><br>Score: ${match.score}`;
            } else {
                resultBox.classList.add('not-done');
                title.textContent = "‚ùå BELUM MENGERJAKAN";
                title.style.color = "#e74c3c";
                desc.textContent = "Data tidak ditemukan di sistem pre-test pre-program ini.";
            }
        }

        // --- TABLE RENDER ---
        function renderTable() {
            const tbody = document.querySelector('#submissions-table tbody');
            const search = document.getElementById('table-search').value.toLowerCase();

            // Get Filter Values from the Checker Card
            const fMode = (document.getElementById('filter-mode').value || "").toLowerCase();
            const fProg = (document.getElementById('filter-program').value || "").toLowerCase();
            const fCity = document.getElementById('filter-city').value;
            const fBranch = document.getElementById('filter-branch').value;

            tbody.innerHTML = '';

            const sorted = [...submissions].reverse(); // Newest first

            sorted.forEach(sub => {
                // Normalize Data
                const subMode = (sub.mode || "").toString().toLowerCase().trim();
                const subProg = (sub.program || "").toString().toLowerCase().trim();
                const subCity = (sub.city || "").toString().trim();
                const subBranch = (sub.branch || "").toString().trim();

                // 1. Text Search
                const rowStr = JSON.stringify(sub).toLowerCase();
                if (search && !rowStr.includes(search)) return;

                // 2. Dropdown Filters
                if (fMode && subMode !== fMode) return;
                if (fProg && subProg !== fProg) return;

                if (fMode === 'offline') {
                    // Startswith because sometimes city in sheet has extra spaces?
                    if (fCity && subCity !== fCity) return;
                    if (fBranch && subBranch !== fBranch) return;
                }

                const tr = document.createElement('tr');

                // Format Date
                let dateStr = "";
                try {
                    dateStr = new Date(sub.timestamp).toLocaleString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                } catch (e) { dateStr = sub.timestamp; }

                // Format Program Name
                let progDisplay = sub.program || "-";
                if (subProg === 'coding') progDisplay = 'Coding';
                if (subProg === 'math') progDisplay = 'Math';
                if (subProg === 'cloc') progDisplay = 'Class of Champions';

                // Mode Badge
                let modeBadge = sub.mode;
                // Capitalize first letter of mode for display
                if (modeBadge) modeBadge = modeBadge.charAt(0).toUpperCase() + modeBadge.slice(1);

                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td style="font-weight:600">${sub.name}</td>
                    <td><span class="badge badge-mode">${modeBadge}</span></td>
                    <td><span class="badge badge-prog">${progDisplay}</span></td>
                    <td>${sub.city} ${sub.branch && sub.branch !== 'Online' ? '- ' + sub.branch : ''}</td>
                    <td><span class="badge badge-score">${sub.score}</span></td>
                `;
                tbody.appendChild(tr);
            });

            // If empty
            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; opacity:0.6; padding:2rem;">Tidak ada data yang cocok dengan filter.</td></tr>';
            }
        }
    </script>
</body>

</html>